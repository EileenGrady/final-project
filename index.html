<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Industrial Pollution</title>

    <!-- title bar -->
    <!-- <nav class="navbar navbar-dark bg-dark navbar-fixed-top">
        <span class="navbar-brand mb-0 h1">Exploring Industrial Pollution in the US</span>
    </nav> -->
    <main>
    
        <!-- OPTIONAL: Scrollytelling Intro -->
        <section id="intro">
          <div class = "container">
            <h1>Exploring Industrial Pollution in the US</h1>
            <h2>In 1969, the burning of the Cuyahoga River in Cleveland, Ohio became a national symbol for the public’s outcry against industrial pollution. The public had been expressing increasing concern throughout the 1950s and 1960s, and the US reached a turning point when the Environmental Protection Agency was established in 1970. The EPA began to monitor and enforce the increasing number of environmental laws passed by Congress aimed at reducing industrial pollution. Today there are two main programs in place that monitor industrial pollution in the United States.</h2>
            <!-- <p><br></p> -->
          </div>
          </section>    

    <!-- Main Scrollytelling Section -->
    <section id="scrollytelling">

        <!-- Map  -->
        <figure>
            <div id="map"></div>
            <div id='legend'>
            </div>
        </figure>
  
        <!-- Prose for the project, additional info describing each scene. -->
        <article>
          <!-- Each div must have the class that you specify in the myScrollama.setup() -->

          <!-- Scene 1 -->
          <div class="step">
            <h3>Superfund Program</h3>
            <p>The Superfund program is responsible for the investigation and clean-up of contaminated sites left over from decades of unregulated industrial manufacturing and other activities. 
              The most highly contaminated sites which require longer-term remedial action take precedence and are placed on the National Priority List (NPL). 
              A site must receive a Hazard Ranking System (HRS) score of 28.5 to be placed on the NPL. 
            </p>
            <p>These sites displayed here are those currently on the NPL, proposed for the NPL, or that were once on the NPL but have been remedied enough to warrant deletion. 
              Also included are sites that qualify for the Superfund Alternative Approach (SAA). 
              The Superfund Alternative (SA) approach requires the same qualifying measures and standards as the NPL, but takes less time and resources to do so. 
            </p>
            <p>But the individual sites you see here are only representative of the true area each encompasses.</p>
          </div>

          <!-- Scene 2 -->
          <div class="step">
            <h3>GE-Pittsfield/Housatonic River Superfund Site</h3>
            <p>Between 1907 and 1987, the General Electric transformer plant on the banks of the Housatonic River in Pittsfield MA “was one of the crown jewels of GE’s electrical infrastructure, high voltage testing, and defense contracting businesses." 
              In the 1930’s, the plant began using PCB’s as a coolant to manufacture their transformers.
            </p>
            <p>PCBs do not break down in the environment and are now known to cause both cancer and serious non-cancer health effects, including neurological, immune, endocrine and reproductive issues in humans. 
              For decades until they were banned in 1979, PCBs leaked from piping throughout the GE plant into the ground, ultimately making their way into the Housatonic River. 
              PCBs were also dumped directly into the river or other areas around the campus. 
            </p>
            <p>Source: <a href='https://www.wbur.org/radioboston/2016/06/29/ge-and-pittsfield' target = '_blank'>GE Left Behind A Complex Legacy In Pittsfield</a></p>
            <img src='images/ge-warning-sign.png'>
            <p>Photo Credit: <a href='https://www.masslive.com/politics/2016/01/in_pittsfield_general_electric.html'>Don Treeger</a></p>
          </div>
  
          <!-- Scene 2a -->
          <div class="step">
            <p>The massive plant was integral to life in Pittsfield, employing nearly 13,000 people at its height in the 1940s and occupying over 300 acres. 
              The plant began to gradually dismantle in the late 1970’s, closed its transformer division in 1986, and finally shuttered for good in 2007. 
            </p>
            <p>The enormous footprint left behind by the plant’s closure is now part of the clean-up area designated by this Superfund site. 
              The cleanup areas include various complexes making up the GE campus, in addition to properties located in the Housatonic's floodplain, the Allendale School area, former oxbow areas resulting from rechannelization of the river in the 1940s, and a half-mile reach of contaminated riverbanks and sediments in the East Branch of the Housatonic River.
            </p>
            <p>Source: <a href='https://www.masslive.com/politics/2016/01/in_pittsfield_general_electric.html' target = '_blank'>In Pittsfield, General Electric plant closures leave bitter memories</a> and <a href='https://www.epa.gov/ge-housatonic' target = '_blank'>EPA</a></p>
            <img src='images/ge-aerial.jpg'>
            <p>Photo Credit: <a href='https://www.berkshireeagle.com/stories/new-life-for-old-buildings,536027'>Warren Fowler</a></p>


          </div>

          <!-- Scene 2b -->
          <div class="step">
            <p>Over time, storms and floods have disturbed PCB laden sediment from the river bottom and soil from contaminated river banks, redistributing it further down the river and into floodplains. 
              The “Rest of River” cleanup area included in this Superfund site covers nearly 125 miles from the confluence of the East and West Branches in Pittsfield to just before the Long Island Sound in Connecticut.
            </p>
            <p>PCBs are persistent in the environment, resistant to degradation, and accumulate quickly in the body but are very slow to leave. 
              Fish and wildlife throughout the Housatonic watershed have tested at very high concentrations of PCBs, and both Massachusetts and Connecticut have issued consumption advisories. 
              Humans are also at risk for exposure by direct contact with contaminated soil or sediment, or consumption of agricultural products produced in the floodplain. 
              PCBs could remain present in the Housatonic River ecosystem for hundreds of years without intervention.
            </p>
            <p>Source: <a href='https://www.epa.gov/ge-housatonic' target = '_blank'>EPA</a></p>
            <img src='images/housatonic-warning.jpg'>
            <p>Photo Credit: <a href='https://www.manchesterjournal.com/stories/think-decades-not-years-to-achieve-one-housatonic-river-health-marker,602748?'>Eagle File Photo</a></p>
          </div>

          <!-- Scene 3 -->
          <div class="step">
            <h3>Southeast Missouri Lead District</h3>
            <p>Missouri is home to the largest lead concentrations in the world, which has been mined for over a century. 
              The seven Superfund sites seen here are defunct lead mines located in the Southeast Missouri Lead District. 
              Mining at these sites left behind hundreds of millions of tons of mining waste contaminated with lead, and other heavy metals and toxic chemicals. 
              Much of this waste is in the form of enormous chat piles that are susceptible to wind and water erosion. 
              By the time the EPA began remediating sites, covering these piles to prevent erosion, the damage was already done.
            </p>
            <p>Source: <a href='http://www.msnbc.com/msnbc/life-missouris-fading-old-lead-belt' target = '_blank'>Life in Missouri’s Fading Old Lead Belt</a></p>
            <img src='images/park-hills-chat-pile.jpg'>
            <p>Photo Credit: <a href='http://www.nbcnews.com/id/8132449/ns/us_news-environment/t/toxic-mound-beloved-ex-mining-town/#.XrttSmhKg2w'>James A. Finley / AP</a></p>
          </div>

          <!-- Scene 3a -->
          <div class="step">
            <p>Contaminants from the chat piles has been distributed throughout the area, now encompassing an area much larger than is first suggested by the location of each site. 
              The total area affected by these seven Superfund sites covers four entire counties in Missouri: Washington, Jefferson, St. Francois, and Madison.
            </p>
          </div>

          <!-- Scene 3b -->
          <div class="step">
            <p>Heavy metals and toxic chemicals also leached into groundwater, eventually draining into the Big River, which runs through Washington, Jefferson, and St. Francois counties. 
              In 1977, heavy rains caused an estimated 50,000 cubic yards of contaminated mining waste to slough into the Big River. 
              As part of remediation efforts, the EPA conducts soil testing and cleanup for properties along the river and located on its floodplain. 
              The EPA also recommends that children in the area undergo annual blood testing for lead.
            </p>
            <p>Source: <a href='epa.gov/mo/big-river-and-floodplain-st-francois-jefferson-and-washington-counties-missouri-fact-sheet-july' target = '_blank'>EPA</a></p>
            <img src='images/big-river-warning.jpg'>
            <p>Photo Credit: <a href='https://www.kbia.org/post/big-river-still-dealing-lead-mining-waste#stream/0'>Kristofor Husted / KBIA</a></p>
          </div>

          <!-- Scene 4 -->
          <div class="step">
            <h3>Toxics Release Inventory (TRI) Program</h3>
            <p>The EPA also monitors active facilities all over the country that are currently releasing toxic chemicals into our air, water, and land through the TRI. 
              The TRI was established under the Emergency Planning and Community Right-to-Know Act (EPCRA) of 1986 after public concern grew over the 1984 Bhopal, India disaster, in which an American-owned Union Carbide pesticide plant released a cloud of highly toxic methyl isocyanate into the air, killing thousands of people. 
              Then in 1985, another, although smaller, toxic cloud was released from a Union Carbide plant on the Kanawha River in West Virginia.
            </p>
            <p>As of 2018 there are 21,557 facilities that report the release of a toxic chemical as part of the TRI program. 
            </p>
          </div>

         <!-- Scene 4a -->
          <div class="step">
            <!-- <div class="tri-time-slider-total"> -->
              <!-- <h3>Top 500 Releasing Facilities (total lbs)</h3> -->
              <p>The TRI does not directly regulate these chemical releases, but rather hopes to incentivize companies into improving their environmental performance by tracking and publishing this data. 
                Use the time slider below to explore total pounds released per year since reporting began in 1987.
              </p>
              <p>Notice the big jump from 1997 to 1998. 
                Seven industry sectors were added to the TRI in 1997, including metal and coal mining, electric power generators, and commercial hazardous waste treatment operations.
              </p>
            <div class="total-release-slider">
              <label id="total-year">1987</label>
              <input id="total-slider" type="range" min="1987" max="2018" step="1" value="0" />
              </div>
            <!-- <div id="timeline"> -->
              <svg id='year-chart' width="650" height="500"></svg>
              <p>I still need to add a circle legend, and fix the chart styling and interactivity.</p>
            <!-- </div> -->
          </div>

          <!-- Scene 5 -->
          <div class="step">
            <h3>But size is not the only determining factor in how dangerous a chemical release is.</h3>
            <p>The Risk-Screening Environmental Indicators (RSEI) model was introduced in 2007 as a way to help identify specific facilities or chemicals that may pose a greater risk. 
              RSEI scores also consider a chemical’s toxicity, its fate and transport through the environment, and the size and location of the exposed population.
            </p>
            <p>Chromium and chromium compounds posed the greatest risk in 2018, composing 39.1% of the country's total RSEI score.</p>
            <!-- <p>The chart below shows the most hazardous chemicals released in 2018, according to their share of RSEI score.</p> -->
            <!-- <p>
              *Right now map only shows ethylene oxide releasing facilities. 
              Thinking about radio buttons where user can view facilities that release each chemical?*
            </p> -->
            <svg id='donut-chart' width="600" height="500"></svg>
            <p>Need to add a circle legend?, and fix chart styling and interactivity.
            </p>
            <!-- <div>
              <input type="radio" id="chromium" name="chemical" value="chromium-layer" checked="checked" onclick="updateMap(value)">
              <label for="chromium">chromium and chromium compounds</label>
          
              <input type="radio" id="ethylene" name="chemical" value="ethylene-layer" onclick="updateMap(value)">
              <label for="ethylene">ethylene oxide</label>
            </div> -->
            <!-- <nav id="menu"></nav> -->
          </div>

          <!-- Scene 5a -->
          <div class="step">
            <p>Ethylene oxide comes in at a close second, composing 30.5% of the country's total RSEI score. 
              Long term exposure to ethylene oxide can increase risk of lymphatic and breast cancers.
            </p>
            <p>A medical sterilizer plant in the Chicago suburb of Willowbrook, Illinois was recently shut down after an EPA report found that ethylene oxide air emissions from the Sterigenics plant were increasing long-term cancer risks for people living up to 25 miles away from the facility. 
              Sterigenics released 4,205 of ethylene oxide in 2016. 
              In response to public pressure, Illinois just passed legislation to phase out the use of ethylene oxide by 2022.</p>
            </p>
          </div>

          <!-- Scene 5b -->
          <!-- <div class="step">
            <p>A medical sterilizer plant in the Chicago suburb of Willowbrook, Illinois was recently shut down after an EPA report found that ethylene oxide air emissions from the Sterigenics plant increased long-term cancer risks for people living up to 25 miles away. 
              Sterigenics released 4,205 of ethylene oxide in 2016. 
              In response to public pressure, Illinois just passed legislation to phase out the use of ethylene oxide by 2022.
            </p>
          </div> -->

          <!-- Scene 5b -->
          <div class="step">
            <p>As of 2018 data, there are 109 ethylene oxide releasing facilities in the US. 
              38 of these are concentrated in Texas and Louisiana.
            </p>
          </div>

          <!-- Scene 5b -->
          <div class="step">
            <p>Texas houses the two highest emitters of ethylene oxide, and releases are expected to increase in the wake of findings by the Texas Commission on Environmental Quality that increase safe exposure levels. 
              These findings are in direct contradiction with the EPA, who recently found ethylene oxide to be far more hazardous than previously thought.
            </p>
          </div>

          <!-- Scene 5b -->
          <div class="step">
          <p>Louisiana has 13 ethylene oxide releasing facilities, eleven of which are located along the Mississippi River between Baton Rouge and New Orleans. 
            The two highest emitters in Louisiana are located here, at 15,100 and 10,413 pounds released annually. 
          </p>
        </div>

          <!-- Scene 5c -->
          <div class="step">
            <p>St. James Parish is currently the only parish in this corridor between Baton Rouge and New Orleans that does not have an ethylene oxide emitting facility. 
            </p>
          </div>

          <!-- Scene 5d -->
          <div class="step">
            <p>This will change if Formosa Chemicals wins the fight to construct a new complex near Sunshine Bridge in St. James Parish. 
              The proposed 2,300 acre complex would be permitted to release up to 15,400 pounds of ethylene oxide annually, more than three times what was emitted at the now defunct Sterigenics plant in Illinois.
            </p>
          </div>

          <!-- Scene 5e -->
          <div class="step">
            <p>Reassurances over the plant's safety do not ease residents who are concerned over Formosa's disreputable history.
            </p>
          </div>

          <!-- Scene 6 -->
          <div class="step">
            <p>An explosion in 2005 at Formosa's Point Comfort, Texas plant resulted in a fire that burned for 5 days and forced the community of Point Comfort into a shelter-in-place order.
            And in 2019 the company was ordered to pay a $50 million settlement to clean up plastic pellets and other pollutants they had been illegally dumping into Lavaca Bay and surrounding waterways.</p>
          </div>

          <!-- Scene 6 -->
          <div class="step">
            <p>Formosa currently operates three plastics facilities in the US. 
              All three are ultimately owned by Formosa Plastics Corporation, headquarted in Taiwan.
            </p>
          </div>

          <!-- Scene 6 -->
          <div class="step">
            <p>Companies responsible for industrial pollution are often located far from the damage they inflict on communities.
            The locations seen here represent the top 10 parent companies who own at least 90 facilities who report to the TRI.</p>
          </div>

          <!-- Scene 6a -->
          <div class="step">
            <h3>Select a company from the dropdown to explore parent company headquarters in relation to the facilities they own.</h3>
            <div class="dropdown show"></div>
              <a class="btn btn-secondary dropdown-toggle" href="href=javascript:return false;" role="button" id="parent-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Choose a company
              </a>
              <div class="dropdown-menu" id="parent-dropdown" aria-labelledby="dropdownMenuLink">
              </div>
              <div id ="company-header"></div>
              <div id ="company-details"></div>
            </div>

          <!-- Scene 6 -->
          <div class="step">
            <p>Let’s go back to West Virginia, where a 1985 chemical release along the Kanawha River helped fuel public outcry for the establishment of the TRI program.
            </p>
          </div>

          <!-- Scene 7 -->
          <div class="step">
            <p>The Kanawha River Valley, or “Chemical Valley” as it is known to some, has long been a site of mining and chemical production.
            </p>
            <img src='images/wv-monsanto.jpg'>
          </div>

          <!-- Scene 7a -->
          <div class="step">
            <p>On a January morning in 2014, around 7,500 gallons of crude 4-Methylcyclohexanemethanol (MCHM) spilled into the Elk River, a tributary of the Kanawha River. 
              The spill originated from Freedom Industries, a chemical plant whose permits did not allow for the discharge of MCHM. 
              MCHM is used as a cleansing agent to remove impurities from coal that contribute to pollution during combustion.
            </p>
            <img src='images/elk-river.jpg'>
          </div>

          <!-- Scene 7b -->
          <div class="step">
            <p>The spill occurred upstream from the primary West Virginia American Water intake center, leaving 300,000 residents in nine counties without drinking water for several days. 
            </p>
          </div>

          <!-- Scene 7c -->
          <div class="step">
            <p>Of course the same rivers that provide us with drinking water also tend to be perfect locations for industry. 
              Show TRI facilities with one-mile of a river here.
            </p>
          </div>

          <!-- Scene 8 -->
          <div class="step">
            <h3>How does this affect you?</h3>
            <p>geocode option to find sites close to you?</p>
          </div>

        </article>
  
      </section>
  
      <!-- OPIONAL: Scrollytelling Outro --> 
      <section id="outro">
        <p style="text-align : center"><br><a href="#top">Jump to top of page</a><br></p>
      </section>
    
    </main>
  

    </section>
      
       

    <!-- Bootstrap core CSS -->
    <link href="vendor\bootstrap\css\bootstrap.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" /> -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css" rel="stylesheet" />
    <!-- Custom styles for this template -->
    <link href='css/style.css' rel='stylesheet' />
    <!-- <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.Default.css"> />
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.css"> /> -->
    <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Average&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans&display=swap" rel="stylesheet">
<body>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="../../../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.js"></script>
    <!-- <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script> -->
    <!-- <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://unpkg.com/d3@5.9.1/dist/d3.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/scrollama/2.2.1/scrollama.min.js"></script>
    <!-- <script src="libs/Leaflet.markercluster/leaflet.markercluster.js"></script> -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.5/chroma.min.js"></script>
    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>





    <!-- <script src='js/app.js'></script> -->

    <script>

      // force page to reload at top
      // jQuery(document).ready(function(){
      //   jQuery(this).scrollTop(0);
      // });

      // code to make intro screen full page on load
      var introEl = $('div.container'),
          introHeadingH = introEl.find('h1').height(),
          windowH = $(window).height();

      introEl.css('padding', (windowH - introHeadingH)/2 + 'px 0');
      

  // ---------Section 0: Make a scrollama--------------- 
  // Create a scrollama object.
  // ---------------------------------------------------
  var myScrollama = scrollama();

  // ---------Section 1: Set Heights---------------
  //#region
  // Set the size of the figure and the height of the steps
  // These are set to constants to improve performance on mobile devices, while keeping the code relatively simple.
  // ----------------------------------------------
  const figureHeight = window.innerHeight * 0.8
  const figureMarginTop = (window.innerHeight - figureHeight) / 2
  const stepH = Math.floor(window.innerHeight * 1.8);
  //#endregion

  // ---------Section 2: HTML -> D3--------------- 
  //#region
  // Save different parts of the page as D3.js objects. We'll use these later for easy restyling. D3.js is used for convenience.
  // ---------------------------------------------
  var figure = d3.select('figure');
  var article = d3.select('article');
  var steps = d3.selectAll('.step');
  //#endregion

  // ---------Section 3: handleResize()---------------
  //#region
  // Create a function which sets the styling of the various elements exactly as you want it to appear
  // This function could increase in complexity as you build responsive scrollytelling webpages. Here, this function
  // is relatively simple.
  // -------------------------------------------------
  function handleResize() {
    
    console.log("handling resize")

    // 1. update height of step elements
    // steps.style('height', stepH + 'px');

    // 2. update height, margin, and layering of the figure
    figure
      .style('height', figureHeight + 'px')
      .style('top', figureMarginTop + 'px')
      .style("z-index", 1);

    // 3. force the article to appear on top of the figure
    article.style("z-index", 2);

    // 4. tell scrollama to update new element dimensions. Not always necessary, but included just to be safe.
    myScrollama.resize();

  }
  //#endregion

  // ---------Section 4: handleStepChange()---------------
  // Create a function to update the map in response to step-triggers.
  // setting map view, and removing and adding layers
  // this gets a little complicated/clunky and I'm not sure this is the best way to proceed
  // -----------------------------------------------------
  function handleStepChange(response) {
  
    console.log(response)

    // create array of layers to be turned off in each case before adding back relevant layers
    const allLayers = ['superfund-layer', 'superfund-labels', 'tri-layer', 'ge-layer', 'watershed-layer', 'river-layer', 'lead-belt-area-layer', 'tri-release-layer', 'ethylene-layer', 'chromium-layer', 'st-james-layer', 'spill-layer', 'tri-river-layer', 'parent-co-layer']

    // create object containing all layer ids and a corresponding label to use in legend
    // const layerLabels = {
    //   'superfund-layer': {
    //     'label': 'Superfund Sites'
    //   },
    //   'superfund-labels': {
    //     'label': ''
    //   },
    //   'tri-layer': {
    //     'label': 'TRI Facilities'
    //   },
    //   'ge-layer': {
    //     'label': 'GE Pittsfield Cleanup Area'
    //   },
    //   'watershed-layer': {
    //     'label': 'watershed'
    //   },
    //   'river-layer': {
    //     'label': 'river'
    //   },
    //   'lead-belt-area-layer': {
    //     'label': 'county outlines'
    //   },
    //   'tri-release-layer': {
    //     'label': ''
    //   },
    //   'ethylene-layer': {
    //     'label': 'ethylene oxide releasing facilities'
    //   },
    //   'chromium-layer': {
    //     'label': 'chromium/chromium compound releasing facilities'
    //   },
    //   'st-james-layer': {
    //     'label': 'St. James Parish'
    //   },
    //   'spill-layer': {
    //     'label': 'county outlines'
    //   },
    //   'tri-river-layer': {
    //     'label': 'TRI facilities'
    //   },
    //   'parent-co-layer': {
    //     'label': 'parent companies'
    //   }
    // }

    // convert keys from layer object into an array to be easily looped through during each scene change
    // const allLayers = Object.keys(layerLabels)

    // create array of individual markers to be removed in each case before adding back relevant markers
    const allMarkers = [freedomMarker, sunshineMarker]
    
    function updateLegend(allLayers) {

      // first clear legend
      document.getElementById('legend').innerHTML = "";

      // then select the legend div element
      var legend = document.getElementById('legend')

      // loop through each layer
      allLayers.forEach(function(layer) {
        
        layout = map.getLayoutProperty(layer, 'visibility')

        if (layer === 'tri-release-layer' && layout === 'visible') {
          drawCircleLegend(layer)
        } else if (layer === 'ethylene-layer' && layout === 'visible') {
          drawCircleLegend(layer)
        } else {
          layerType = map.getLayer(layer).type

          // if layer is visible in the scene
          if (layout === 'visible') {

            // first define color for legend key based on layer type (circle, line, or fill)
            if (layerType === 'circle') {
              var color = map.getPaintProperty(layer, 'circle-color')
            } else if (layerType === 'line') {
              var color = map.getPaintProperty(layer, 'line-color')
            } else if (layerType === 'fill') {
              var color = map.getPaintProperty(layer, 'fill-color')
            }

            // and append the layer's color and label to the legend element
            legend.innerHTML +=
            '<span style="background-color:' + color + '"></span> ' +
            '<label>' + layer + '</label><br>';
          }
        }
        })
      } 

      function drawCircleLegend(layer) {
        mapLayer = map.getLayer(layer)
      }

    switch(response.index) {
      case 0:
        // Scene 1
        // Superfund sites
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', null);
        map.setPaintProperty('superfund-layer', 'circle-radius', 2.5)
        updateLegend(allLayers);
        break;

      case 1:
        // Scene 2
        // GE Pittsfield Site
        map.flyTo({
          center: [-73.2420, 42.4483],
          zoom: 14,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['==', 'SITE_NAME', 'GE PITTSFIELD HOUSATONIC RIVER SUPERFUND SITE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6);
        updateLegend(allLayers);
        break;
      
      case 2:
        // Scene 2a
        // Full GE site extent map
        map.flyTo({
          center: [-73.2519, 42.4488], 
          zoom: 13,
          pitch: 0,
          bearing: 0,
          speed: .25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['==', 'SITE_NAME', 'GE PITTSFIELD HOUSATONIC RIVER SUPERFUND SITE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6)
        map.setLayoutProperty('ge-layer','visibility', 'visible');
        updateLegend(allLayers);
        break;

      case 3:
        // Scene 2b
        // Housatonic River extent
        map.flyTo({
          center: [-72.87774, 42.18110], 
          zoom: 8.92,
          pitch: 37.8,
          bearing: 129.64,
          speed: .3
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('river-layer','visibility', 'visible');
        map.setFilter('river-layer', ['in', 'name', 'Housatonic River', 'East Branch Housatonic River']);
        map.setLayoutProperty('watershed-layer','visibility', 'visible');
        map.setFilter('watershed-layer', ['==', 'NAME', 'Housatonic']);
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['==', 'SITE_NAME', 'GE PITTSFIELD HOUSATONIC RIVER SUPERFUND SITE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6);
        updateLegend(allLayers);
        break;

      case 4:
        // Scene 3
        // Missouri Old Lead Belt sites
        map.flyTo({
          center: [-90.8029, 37.852], 
          zoom: 9,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setLayoutProperty('superfund-labels','visibility', 'visible');
        map.setFilter('superfund-labels', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6);
        updateLegend(allLayers);
        break;

      case 5:
        // Scene 3a
        // Missouri Old Lead Belt areas
        map.flyTo({
          center: [-90.97511, 37.98508], 
          zoom: 8,
          pitch: 0,
          bearing: 0,
          speed: .25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setLayoutProperty('superfund-labels','visibility', 'visible');
        map.setFilter('superfund-labels', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6)
        map.setLayoutProperty('lead-belt-area-layer','visibility', 'visible');
        updateLegend(allLayers);
        break;

      case 6:
      // Scene 3b
      // Big River
        map.flyTo({
          center: [-90.78435, 38.03558], 
          zoom: 9.87,
          pitch: 38.5,
          bearing: -21.6,
          speed: .5
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setLayoutProperty('watershed-layer','visibility', 'visible');
        map.setFilter('watershed-layer', ['==', 'NAME', 'Big']);
        map.setLayoutProperty('river-layer','visibility', 'visible');
        map.setFilter('river-layer', ['==', 'name', 'Big River']);
        map.setFilter('superfund-layer', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6);
        updateLegend(allLayers);
        break;

      case 7:
        // Scene 4
        // overall TRI facility distribution
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-layer','visibility', 'visible');
        map.setFilter('tri-layer', null);
        map.setPaintProperty('tri-layer', 'circle-radius', 2);
        updateLegend(allLayers);
        break;

      case 8:
        // Scene 4a
        // TRI top releasing facilities--time slider
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-release-layer','visibility', 'visible');
        document
          .getElementById('total-slider')
          .addEventListener('input', function(e) {
          var year = parseInt(e.target.value, 10);
          filterTotalRelease(year);
        });
        updateLegend(allLayers);
        break;

      case 9:
        // Scene 5
        // RSEI scores--chromium layer
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        // map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        map.setLayoutProperty('chromium-layer','visibility', 'visible');
        updateLegend(allLayers);
        break;

        case 10:
        // Scene 5a
        // ethylene oxide layer
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        updateLegend(allLayers);
        break;

        case 11:
        // Scene 5b
        // ethylene oxide along Gulf
        map.flyTo({
          center: [-102.3122, 28.6090],
          zoom: 4.9478,
          pitch: 0,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        updateLegend(allLayers);
        break;

        case 12:
        // Scene 5b
        // ethylene oxide Texas
        map.flyTo({
          center: [-96.9906, 29.4035],
          zoom: 6.789,
          pitch: 0,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        updateLegend(allLayers);
        break;

        case 13:
        // Scene 5b
        // ethylene oxide louisiana
        map.flyTo({
          center: [-91.8152, 30.1678],
          zoom: 7.7827,
          pitch: 0,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        updateLegend(allLayers);
        break;

        case 14:
        // Scene 5c
        // St. James Parish
        map.flyTo({
          center: [-91.0835, 30.0772],
          zoom: 8.78,
          pitch: 0,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        map.setLayoutProperty('st-james-layer','visibility', 'visible');
        updateLegend(allLayers);
        break;

        case 15:
        // Scene 5c
        // new proposed plant
        map.flyTo({
          center: [-91.0835, 30.0772],
          zoom: 9.78,
          pitch: 057,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        map.setLayoutProperty('st-james-layer','visibility', 'visible');
        map.once('moveend', function(e) {
          sunshineMarker.addTo(map);
        });
        updateLegend(allLayers);
        break;

        case 16:
        // Scene 5c
        // new proposed plant--repeat
        map.flyTo({
          center: [-91.0835, 30.0772],
          zoom: 9.78,
          pitch: 057,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        map.setLayoutProperty('st-james-layer','visibility', 'visible');
        sunshineMarker.addTo(map);
        updateLegend(allLayers);
        break;

        case 17:
        // Scene 5d
        // Texas Formosa plant
        map.flyTo({
          center: [-96.6307, 28.6309],
          zoom: 11.97,
          pitch: 56.6538,
          bearing: 20,
          speed: 0.5
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-layer','visibility', 'visible');
        map.setFilter('tri-layer', ['==', 'FACILITY_NAME', 'FORMOSA PLASTICS CORP TEXAS']);
        map.setPaintProperty('tri-layer', 'circle-radius', 8);
        updateLegend(allLayers);
        break;

        case 18:
        // Scene 5d
        // US Formosa plants
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0,
          speed: 0.5
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-layer','visibility', 'visible');
        map.setFilter('tri-layer', ['==', 'PARENT_CO_NAME', 'FORMOSA PLASTICS CORP USA']);
        map.setPaintProperty('tri-layer', 'circle-radius', 6);
        updateLegend(allLayers);
        break;

        case 19:
        // Scene 8
        // Parent Companies
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('parent-co-layer','visibility', 'visible');
        map.setFilter('parent-co-layer', null);
        updateLegend(allLayers);
        if (map.getSource('company-line-layer')) {
          map.removeLayer('company-line-layer')
        };
        break;

        case 20:
        // Scene 8
        // Parent Companies interactive scene
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('parent-co-layer','visibility', 'visible');
        map.setPaintProperty('tri-layer', 'circle-radius', 4)
        map.setFilter('parent-co-layer', null);
        $('#company-header').text('')
        $('#company-details').text('')
        updateLegend(allLayers);
        if (map.getSource('company-line-source')) {
          map.removeLayer('company-line-layer')
          map.removeSource('company-line-source')
        };
        break;

        case 21:
        // Scene 6
        // Chemical Valley, West Virginia
        map.flyTo({
          center: [-81.8162, 38.3771],
          zoom: 11.115,
          pitch: 59.5,
          bearing: 0,
          speed: 0.75
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-layer','visibility', 'visible');
        map.setFilter('tri-layer', null);
        map.setPaintProperty('tri-layer', 'circle-radius', 6);
        if (map.getSource('company-line-source')) {
          map.removeLayer('company-line-layer')
          map.removeSource('company-line-source')
        };
        updateLegend(allLayers);
        break;

        case 22:
        // Scene 6
        // Chemical Valley, West Virginia--repeat
        map.flyTo({
          center: [-81.8162, 38.3771],
          zoom: 11.115,
          pitch: 59.5,
          bearing: 0,
          speed: 0.75
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-layer','visibility', 'visible');
        map.setPaintProperty('tri-layer', 'circle-radius', 6);
        updateLegend(allLayers);
        break;
        
        case 23:
        // Scene 6a
        // Zoom to Freedom Industry facility that had chemical spill
        map.flyTo({
          center: [-81.6713, 38.3618],
          zoom: 10.78,
          pitch: 0,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-layer','visibility', 'visible');
        map.setPaintProperty('tri-layer', 'circle-radius', 6);
        map.once('moveend', function(e) {
          freedomMarker.addTo(map);
        });
        updateLegend(allLayers);
        break;

        case 24:
        // Scene 6b
        // show counties affected by spill
        map.flyTo({
          center: [-82.3395, 38.4080],
          zoom: 8,
          pitch: 0,
          bearing: 0,
          speed: 0.5
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('spill-layer','visibility', 'visible');
        freedomMarker.addTo(map);
        updateLegend(allLayers);
        break;

        case 25:
        // Scene 7
        // all facilities along waterways in US?
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-river-layer','visibility', 'visible');
        updateLegend(allLayers);
        break;

        case 26:
        // Scene 9
        // How does this affect you?
        // Geocode option to find sites close to you?
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        if (map.getSource('company-line-source')) {
          map.removeLayer('company-line-layer')
          map.removeSource('company-line-source')
        };
   
      default:
        // do nothing

    }

  }

  // ---------Section 5: init()--------------- 
  // Create a function that will run just once that first makes sure all the elements are sized like you want them,
  // and then sets up the scrollama. Finally, add an event listener to detect if the screen size has changed.
  // -----------------------------------------
  function init() {

    // 1. force a resize on load to ensure proper dimensions are sent to scrollama
    handleResize();

    // 2. Setup the scrollama
    myScrollama.setup({
      step: '.step',
      offset: Math.floor(window.innerHeight) * 0.95 + "px",
      // set to true to see debug horizontal line
      debug: true,
    }).onStepEnter(handleStepChange)
      
    // setup resize event
    window.addEventListener('resize', handleResize);
  }


  // ---------Section 6: Wrap Up--------------- 
  // This is where you'll want to include any other JavaScript that you've created for the webpage, and to run the init() function. 
  // ------------------------------------------
  // init();

  // DARK BASEMAP
  // add mapbox access token
  mapboxgl.accessToken = 'pk.eyJ1IjoiZWlsZWVuZ3JhZHkiLCJhIjoiY2pvNG00eXVjMDFlcjNxcW1yZ3I2OTJ2ZSJ9.l2EtBykdOJSCNiszd2NbaA';

  // initalize map
  var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/eileengrady/ck9vlhb4417hl1iqmcr1eoyr4', // stylesheet location
    center: [-107.79, 35.08], // starting position [lng, lat]
    zoom: 3.789, // starting zoom
    scrollZoom: false
  });

  // create zoom control
  map.addControl(new mapboxgl.NavigationControl());

  // create marker for Freedom Industries in WV
  var freedomMarker = new mapboxgl.Marker()
    .setLngLat([-81.606774, 38.368888])

  // create marker for Formosa Chemical plant near Sunshine bridge
  var sunshineMarker = new mapboxgl.Marker()
    .setLngLat([-90.910054, 30.057623])

    var years = [
      '1987',
      '1988',
      '1989',
      '1990',
      '1991',
      '1992',
      '1993',
      '1994',
      '1995',
      '1996',
      '1997',
      '1998',
      '1999',
      '2000',
      '2001',
      '2002',
      '2003',
      '2004',
      '2005',
      '2006',
      '2007',
      '2008',
      '2009',
      '2010',
      '2011',
      '2012',
      '2013',
      '2014',
      '2015',
      '2016',
      '2017',
      '2018'
    ];

    // declare function to filter facilities by year by time slider
    function filterTotalRelease(totalYear) {
      var total = 'TOTAL'
      var totalField = total.concat(totalYear)
      map.setPaintProperty('tri-release-layer', 'circle-radius', ['sqrt', ['/', ['get', totalField], 100000]]);
      map.setPaintProperty('tri-release-layer', 'circle-color', '#f94144');

      // Set the label to the month
      document.getElementById('total-year').textContent = totalYear;

      // select corresponding bar in bar chart to create interaction
      d3.selectAll('.bar')
        .filter(function(d) { return d.YEAR == totalYear; })
        .transition()
        .duration(300)
        .attr('opacity', 0.6)

      // return bar to normal when slider changes to new year
      d3.selectAll('.bar')
        .filter(function(d) { return d.YEAR != totalYear; })
          .transition()
          .duration(300)
          .attr('opacity', 1)

        // .attr('x', (a) => xScale(a.TOTAL_RELEASE) - 5)
        // .attr('width', xScale.bandwidth() + 10)
    }

  // create list of parent companies
  const parentCompanies = ['US DEPARTMENT OF DEFENSE', 'BERKSHIRE HATHAWAY INC', 'CEMEX INC', 'ARGOS USA CORP', 'KOCH INDUSTRIES INC', 'CRH AMERICAS INC', 'CLEAN HARBORS INC', 'TYSON FOODS INC', 'MARATHON PETROLEUM CORP', 'MARTIN MARIETTA MATERIALS INC']
  
  // declare function to populate dropdown menu and call function to filter map
  function addCompanyFilter(company) {

    // make the selection once
    var dropdown = $('#parent-dropdown');

    // populate dropdown with company values
    //for each value in parent company array
    $.each(parentCompanies, function(key, value) {
      // append a new element
      dropdown.append("<a class='dropdown-item' value='"+ key +"' href='javascript:return false;''>" + value + "</a>")  //append new dropdown item
    });

    //assign click event to dropdown filter, call filterMap when dropdown selection made
    $('.dropdown-menu a').click(function(e) {
      company = this.innerHTML;
      filterMap(company);
      updateDetails(company)
    });
    }

    var popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false
    });

    // filter parent company and its TRI facilities when dropdown chanes
    function filterMap(company) {

      // check if line layer exists and remove it first
      if (map.getSource('company-line-source')) {
        map.removeLayer('company-line-layer')
        map.removeSource('company-line-source')
      };
      
      // set filters and properties to show chosen parent company and its facilities
      map.setFilter('parent-co-layer', ['==', 'parentCompany', company]);
      map.setPaintProperty('parent-co-layer', 'circle-radius', 8);
      map.setLayoutProperty('tri-layer','visibility', 'visible'); 
      map.setFilter('tri-layer', ['==', 'PARENT_CO_NAME', company]);

      // get the child facility source data
      var facilities = map.querySourceFeatures('composite', {
          sourceLayer: 'tri-facilities-174q3j',
          filter: ['==', 'PARENT_CO_NAME', company]
      });

      // get the parent company source data
      var parent = map.querySourceFeatures('parent-co-source', {
          filter: ['==', 'parentCompany', company]
        });
      
      // create turf point from coordinates of parent company
      var from = turf.point([parent[0].properties.longitude, parent[0].properties.latitude]).geometry.coordinates;

      // declare empty array to populate line features with
      var lineData = []

      // for each child facility 
      facilities.forEach(function(feature) {

        // create turf point from its coordinates
        var to = turf.point([feature.properties.LONGITUDE, feature.properties.LATITUDE]).geometry.coordinates;
        
        // create line string from parent company location to child facility
        var line = turf.lineString([from, to]);

        // push each line string to the lineData array
        lineData.push(line)
      })

      // add new source using lineData created above
      map.addSource('company-line-source', {
         type: 'geojson', 
         data: {
           'type': 'FeatureCollection',
           'features': lineData
         }
      });
      
      // add layer from the lineData source
      map.addLayer({
        'id': 'company-line-layer',
        'type': 'line',
        'source': 'company-line-source',
        'layout': {
          'line-join': 'round',
          'line-cap': 'round'
        },
        'paint': {
          'line-color': '#888',
          'line-width': 1,
          'line-opacity': .5
        }
      });


      
      // map.on('mouseenter', 'tri-layer', function(e) {
    
      //   // var features = map.queryRenderedFeatures(e.point);
      //   var feature = e.features[0];
      //   // console.log(features)

      //   map.getCanvas().style.cursor = 'pointer';

      //   var parent = map.querySourceFeatures('parent-co-source', {
      //     // sourceLayer: 'parent-source-layer',
      //     filter: ['==', 'parentCompany', feature.properties.PARENT_CO_NAME]
      //   });

      //   // var parentCo = parent[0].properties.parentCompany

      //   var from = turf.point(e.features[0].geometry.coordinates);
      //   var to = turf.point([parent[0].properties.longitude, parent[0].properties.latitude]);

      //   var options = {units: 'miles'};

      //   var distance = turf.distance(from, to, options);

      //   // Populate the popup and set its coordinates
      //   // based on the feature found.
      //   popup.setLngLat(e.features[0].geometry.coordinates)
      //       .setHTML('<h3>' + 
      //         e.features[0].properties.FACILITY_NAME + 
      //         ' is ' + 
      //         distance + 
      //         ' miles from its parent company, ' + 
      //         parent[0].properties.parentCompany + 
      //         '.<h/3>')
      //       .addTo(map);

      // });

      // map.on('mouseleave', 'tri-layer', function() {
      //   map.getCanvas().style.cursor = '';
      //   popup.remove();
      // });
    }

    // need to access parent company layer data to update info box with description of each company
    // this still needs work
    function updateDetails(company) {
      var parentCompany = map.querySourceFeatures('parent-co-source', {
          filter: ['==', 'parentCompany', company]
        });
      console.log(parentCompany[0].properties.parentCompany)
      $('#company-header').text(parentCompany[0].properties.name)
      $('#company-details').text(parentCompany[0].properties.industry)
    }

  map.on('load', function() {

    var popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false
    });

    // construct popup for Superfund sites
    map.on('mouseenter', 'superfund-layer', function(e) {
      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = 'pointer';

      var coordinates = e.features[0].geometry.coordinates.slice();

      // Ensure that if the map is zoomed out such that multiple
      // copies of the feature are visible, the popup appears
      // over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      // Populate the popup and set its coordinates
      // based on the feature found.
      popup
      .setLngLat(coordinates)
      .setHTML('<h3>' + e.features[0].properties.SITE_NAME + '<h/3>' +
        '<h4>Location: ' + e.features[0].properties.CITY + ' ' + e.features[0].properties.STATE + '<h/4>' +
        '<h4>Site Type: ' + e.features[0].properties.SITE_TYPE + '<h/4>' +
        '<h4>Status: ' + e.features[0].properties.NPL_STATUS_x + '<h/4>' +
        '<h4>HRS score: ' + e.features[0].properties.HRS_SCORE + '<h/4>')
      .addTo(map);
    });

    map.on('mouseleave', 'superfund-layer', function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
    });

    // add source and layer for GE Pittsfield site map
    map.addSource('ge-source', {
      type: 'geojson',
      data: 'data/ge-site-area.geojson'
    });

    map.addLayer({
      'id': 'ge-layer',
      'type': 'line',
      'source': 'ge-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#F9C74F',
        'line-width': 1
      }
    });

    // construct popup for GE site map layer
    map.on('mouseenter', 'ge-layer', function(e) {
      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = 'pointer';

      // var coordinates = e.features[0].geometry.coordinates[0];
      var coordinates = e.lngLat;

      // Ensure that if the map is zoomed out such that multiple
      // copies of the feature are visible, the popup appears
      // over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }

    // Populate the popup and set its coordinates
    // based on the feature found.
    popup
      .setLngLat(coordinates)
      .setHTML('<h3>' + e.features[0].properties.name + '<h/3>')
      .addTo(map);
    });

    map.on('mouseleave', 'ge-layer', function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
    });

    // add source and layer for watershed layer
    map.addSource('watershed-source', {
      type: 'geojson',
      data: 'data/watersheds/watersheds.geojson'
    });

    map.addLayer({
      'id': 'watershed-layer',
      'type': 'fill',
      'source': 'watershed-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'fill-color': '#A2D9CE',
        'fill-opacity': .25,
        'fill-outline-color': '#A2D9CE'
      }
    });

    // add source and layer for River layer
    map.addSource('river-source', {
      type: 'geojson',
      data: 'data/rivers.geojson'
    });

    map.addLayer({
      'id': 'river-layer',
      'type': 'line',
      'source': 'river-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#5FAECC',
        'line-width': 3
      }
    });

    // add source and layer for Lead Belt areas
    map.addSource('lead-belt-area-source', {
      type: 'geojson',
      data: 'data/missouri-lead-belt.geojson'
    });

    map.addLayer({
      'id': 'lead-belt-area-layer',
      'type': 'line',
      'source': 'lead-belt-area-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#696969',
        'line-width': 3
      }
    });

    // add source and layer for top tri sites
    map.addSource('tri-release-source', {
      type: 'geojson',
      data: 'data/top-tri-releases.geojson'
    });

    map.addLayer({
      'id': 'tri-release-layer',
      'type': 'circle',
      'source': 'tri-release-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#f94144',
        'circle-opacity': 0.65,
        'circle-radius': [
          'sqrt', ['/', ['get', 'TOTAL1987'], 100000]
        ],
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5,
        'circle-stroke-opacity': 0.65
      }
    });

    filterTotalRelease('1987');

    document
      .getElementById('total-slider')
      .addEventListener('input', function(e) {
      var year = parseInt(e.target.value, 10);
      filterTotalRelease(year);
    });

    // add sources and layers for chromium and ethylene oxide facilities
    map.addSource('chromium-source', {
      type: 'geojson',
      data: 'data/chromium-facilities.geojson'
    });

    map.addSource('ethylene-source', {
      type: 'geojson',
      data: 'data/ethylene-facilities.geojson'
    });

    map.addLayer({
      'id': 'chromium-layer',
      'type': 'circle',
      'source': 'chromium-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#66C5CC',
        'circle-radius': [
          'sqrt', ['/', ['get', 'ON_SITE_RELEASE_TOTAL'], 1000]
        ],
        'circle-opacity': .75,
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5
      }
    });

    map.addLayer({
      'id': 'ethylene-layer',
      'type': 'circle',
      'source': 'ethylene-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#F6CF71',
        'circle-radius': [
          'sqrt', ['/', ['get', 'ON_SITE_RELEASE_TOTAL'], 25]
        ],
        'circle-opacity': .75,
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5
      }
    });

    // add source and layer for St. James Parish
    map.addSource('st-james-source', {
      type: 'geojson',
      data: 'data/st-james-parish.geojson'
    });

    map.addLayer({
      'id': 'st-james-layer',
      'type': 'line',
      'source': 'st-james-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#696969',
        'line-width': 3
      }
    });

    // add source and layer for counties affected by Freedom Industry spill
    map.addSource('spill-source', {
      type: 'geojson',
      data: 'data/elk-river-spill-counties.geojson'
    });

    map.addLayer({
      'id': 'spill-layer',
      'type': 'line',
      'source': 'spill-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#696969',
        'line-width': 3
      }
    });

    // add source and layer for tri facilities near rivers
    map.addSource('tri-river-source', {
      type: 'geojson',
      data: 'data/tri-near-rivers.geojson'
    });

    map.addLayer({
      'id': 'tri-river-layer',
      'type': 'circle',
      'source': 'tri-river-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#f94144',
        'circle-radius': 3,
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5
      }
    });

    // add source and layer for parent companies
    map.addSource('parent-co-source', {
      type: 'geojson',
      data: 'data/parent-companies.geojson'
    });

    map.addLayer({
      'id': 'parent-co-layer',
      'type': 'circle',
      'source': 'parent-co-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#5DADEC',
        'circle-radius': 6,
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5
      }
    });

    // construct popup for GE site map layer
    map.on('mouseenter', 'parent-co-layer', function(e) {
      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = 'pointer';

      // var coordinates = e.features[0].geometry.coordinates[0];
      var coordinates = e.lngLat;

      // Ensure that if the map is zoomed out such that multiple
      // copies of the feature are visible, the popup appears
      // over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      // Populate the popup and set its coordinates
      // based on the feature found.
      popup
        .setLngLat(coordinates)
        .setHTML('<h3>' + e.features[0].properties.parentCompany + '<h/3>')
        .addTo(map);
      });

      map.on('mouseleave', 'parent-co-layer', function() {
        map.getCanvas().style.cursor = '';
        popup.remove();
      });

        // function updateLegend() {
        //   layers.forEach(function(layerId) {
        //     console.log(layerId)

        //     // var layer = map.getLayer(layerid);
        //     // if (layer.type === 'circle') {
        //     //   layer.paint['circle-fill']
        //     // } else if (layer.type === 'fill') {
        //     //   layer.paint['line-color']
        //     // }

        //   // console.log(layers)
        //   })
        // } 


    init();

    // draw yearly release total chart
    drawYearChart();

    // draw donut chart for RSEI scores by chemical
    drawDonutChart();

    // call function to create and populate parent company filter
    addCompanyFilter()

  })

  // declare function that draws d3 chart for yearly release totals
  function drawYearChart() {
    var svg = d3.select("#year-chart"),
        margin = {top: 30, right: 20, bottom: 50, left: 70},
        width = svg.attr("width") - margin.left - margin.right,
        height = svg.attr("height") - margin.top - margin.bottom;

    var xScale = d3.scaleBand().range ([0, width]).padding(0.2),
        yScale = d3.scaleLinear().range ([height, 0]).clamp(true);;

    var g = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.csv("/data/year-totals.csv").then(function(data) {

        xScale.domain(data.map(function(d) { return d.YEAR; }));
        yScale.domain([0, d3.max(data, function(d) { return d.TOTAL_RELEASE; })]);

        g.append("g")
         .attr("transform", "translate(0," + height + ")")
         .call(d3.axisBottom(xScale))
        .selectAll("text")
          .attr("transform", "rotate(45)")
          .attr("dy", ".55em")
          .style("text-anchor", "start");

        var formatValue = d3.format("0.2s");

        g.append("g")
         .call(d3.axisLeft(yScale).tickFormat(function(d){
             return formatValue(d);
         }).ticks(10, "~s"))
         .append("text")
         .attr("y", 6)
         .attr("dy", "0.71em")
         .attr("text-anchor", "end")
         .text("value");

         g.append('g')
        .attr('class', 'grid')
        .call(d3.axisLeft()
        .scale(yScale)
        .tickSize(-width, 0, 0)
        .tickFormat(''))

        svg.append('text')
        .attr('class', 'label')
        .attr('x', -(height / 2.5) - margin.left)
        .attr('y', margin.bottom / 1.8)
        .attr('transform', 'rotate(-90)')
        .attr('text-anchor', 'middle')
        .text('Total Pounds Released')

         g.selectAll(".bar")
         .data(data)
         .enter().append("rect")
         .attr("class", "bar")
         .attr("x", function(d) { return xScale(d.YEAR); })
         .attr("y", function(d) { return yScale(d.TOTAL_RELEASE); })
         .attr("width", xScale.bandwidth())
         .attr("height", function(d) { return height - yScale(d.TOTAL_RELEASE); })
        });

    }

    // declare function that draws d3 chart for chemical shares of RSEI scores
    function drawDonutChart() {

      const width = 571,
        chartWidth = 300,
        chartHeight = 300,
        height = 378,
        radius = Math.min(chartWidth, chartHeight) / 2,
        innerRadius = radius - radius + 40;

      var svg = d3.select('#donut-chart')
        .attr('width', width)
        .attr('height', height);

      var donutColors = ['#66C5CC','#F6CF71','#F89C74','#DCB0F2','#87C55F','#9EB9F3','#FE88B1','#C9DB74','#8BE0A4','#B497E7','#D3B484','#B3B3B3']

      d3.csv("/data/chemical-scores.csv").then(function(data) {
 
        var pie = d3.pie()
          .value(function(d) {return +d.Score; })

        var arc = d3.arc()
          .innerRadius(innerRadius)
          .outerRadius(radius);

        var div = d3.select("body").append("div")
          .attr("class", "tooltip-donut")
          .style('z-index', '10')
          .style("opacity", 0);

        var arcGroup = svg
          .append('g')
          // .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
          .attr("transform", "translate(425, 175)")
          .attr('class', 'arc-group'); 

        arcGroup
          .selectAll('.arc')
          .data(pie(data))
          .enter()
          .append('g')
          .attr('class', 'arc-group')
          .append('path')
          .attr('class', 'arc')
          .attr('d', arc)
          .attr('fill', (d, i) => donutColors[i])
          .on('mouseenter', function(d) {
            console.log(d.Score)
            d3.select(this).transition()
              .duration('50')
              .attr('opacity', '.85')
            div.transition()
              .duration('50')
              .style("opacity", 1);
            let num = (Math.round((d.Score / d.data.all) * 100)).toString() + '%';
            div.html(d.Score)
              .style("left", (d3.event.pageX + 10) + "px")
              .style("top", (d3.event.pageY - 15) + "px");
          })
          .on('mouseout', function(d) {
            d3.select(this).transition()
              .duration('50')
              .attr('opacity', '1');
            div.transition()
              .duration('50')
              .style("opacity", 0);
          })

          // add colored dots for legend
          svg.selectAll("mydots")
            .data(data)
            .enter()
            .append("circle")
              .attr("cx", 50)
              .attr("cy", function(d,i){ return 30 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
              .attr("r", 7)
              .style('fill', (d, i) => donutColors[i])

          // add labels for legend
          svg.selectAll("mylabels")
            .data(data)
            .enter()
            .append("text")
              .attr("x", 70)
              .attr("y", function(d,i){ return 30 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
              // .style("fill", function(d){ return color(d)})
              .text(function(d) {return d.SortName; })
              .attr("text-anchor", "left")
              .style("alignment-baseline", "middle")
        

          })

  }
  
    </script>

    
  </body>

  
</html>
