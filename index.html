<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Industrial Pollution</title>

    <!-- title bar -->
    <!-- <nav class="navbar navbar-dark bg-dark navbar-fixed-top">
        <span class="navbar-brand mb-0 h1">Exploring Industrial Pollution in the US</span>
    </nav> -->
    <main>
    
        <!-- OPTIONAL: Scrollytelling Intro -->
        <section id="intro">
          <div class = "container">
            <h1>Exploring Industrial Pollution in the US</h1>
            <h2>In 1969, the burning of the Cuyahoga River in Cleveland, Ohio became a national symbol for the public’s outcry against industrial pollution. The public had been expressing increasing concern throughout the 1950s and 1960s, and the US reached a turning point when the Environmental Protection Agency was established in 1970. The EPA began to monitor and enforce the increasing number of environmental laws passed by Congress aimed at reducing industrial pollution. Today there are two main programs in place that monitor industrial pollution in the United States.</h2>
            <!-- <p><br></p> -->
          </div>
          </section>    

    <!-- Main Scrollytelling Section -->
    <section id="scrollytelling">

        <!-- Map  -->
        <figure>
            <div id="map"></div>
            <div id='legend'>
            </div>
        </figure>
  
        <!-- Prose for the project, additional info describing each scene. -->
        <article>
          <!-- Each div must have the class that you specify in the myScrollama.setup() -->

          <!-- Scene 1 -->
          <div class="step">
            <h3>Superfund Program</h3>
            <p>The Superfund program is responsible for the investigation and clean-up of contaminated sites left over from decades of unregulated industrial manufacturing and other activities. 
              The most highly contaminated sites which require longer-term remedial action take precedence and are placed on the National Priority List (NPL). 
              A site must receive a Hazard Ranking System (HRS) score of 28.5 to be placed on the NPL. 
            </p>
            <p>These sites displayed here are those currently on the NPL, proposed for the NPL, or that were once on the NPL but have been remedied enough to warrant deletion. 
              Also included are sites that qualify for the Superfund Alternative Approach (SAA). 
              The Superfund Alternative (SA) approach requires the same qualifying measures and standards as the NPL, but takes less time and resources to do so. 
            </p>
            <p>But the individual sites you see here are only representative of the true area each encompasses.</p>
          </div>

          <!-- Scene 2 -->
          <div class="step">
            <h3>GE-Pittsfield/Housatonic River Superfund Site</h3>
            <p>Between 1907 and 1987, the General Electric transformer plant on the banks of the Housatonic River in Pittsfield MA “was one of the crown jewels of GE’s electrical infrastructure, high voltage testing, and defense contracting businesses." 
              In the 1930’s, the plant began using PCB’s as a coolant to manufacture their transformers.
            </p>
            <p>PCBs do not break down in the environment and are now known to cause both cancer and serious non-cancer health effects, including neurological, immune, endocrine and reproductive issues in humans. 
              For decades until they were banned in 1979, PCBs leaked from piping throughout the GE plant into the ground, ultimately making their way into the Housatonic River. 
              PCBs were also dumped directly into the river or other areas around the campus. 
            </p>
            <p>Source: <a href='https://www.wbur.org/radioboston/2016/06/29/ge-and-pittsfield' target = '_blank'>GE Left Behind A Complex Legacy In Pittsfield</a></p>
            <img src='images/ge-warning-sign.png'>
            <p>Photo Credit: <a href='https://www.masslive.com/politics/2016/01/in_pittsfield_general_electric.html'>Don Treeger</a></p>
          </div>
  
          <!-- Scene 2a -->
          <div class="step">
            <p>The massive plant was integral to life in Pittsfield, employing nearly 13,000 people at its height in the 1940s and occupying over 300 acres. 
              The plant began to gradually dismantle in the late 1970’s, closed its transformer division in 1986, and finally shuttered for good in 2007. 
            </p>
            <p>The enormous footprint left behind by the plant’s closure is now part of the clean-up area designated by this Superfund site. 
              The cleanup areas include various complexes making up the GE campus, in addition to properties located in the Housatonic's floodplain, the Allendale School area, former oxbow areas resulting from rechannelization of the river in the 1940s, and a half-mile reach of contaminated riverbanks and sediments in the East Branch of the Housatonic River.
            </p>
            <p>Source: <a href='https://www.masslive.com/politics/2016/01/in_pittsfield_general_electric.html' target = '_blank'>In Pittsfield, General Electric plant closures leave bitter memories</a> and <a href='https://www.epa.gov/ge-housatonic' target = '_blank'>EPA</a></p>
            <img src='images/ge-aerial.jpg'>
            <p>Photo Credit: <a href='https://www.berkshireeagle.com/stories/new-life-for-old-buildings,536027'>Warren Fowler</a></p>


          </div>

          <!-- Scene 2b -->
          <div class="step">
            <p>Over time, storms and floods have disturbed PCB laden sediment from the river bottom and soil from contaminated river banks, redistributing it further down the river and into floodplains. 
              The “Rest of River” cleanup area included in this Superfund site covers nearly 125 miles from the confluence of the East and West Branches in Pittsfield to just before the Long Island Sound in Connecticut.
            </p>
            <p>PCBs are persistent in the environment, resistant to degradation, and accumulate quickly in the body but are very slow to leave. 
              Fish and wildlife throughout the Housatonic watershed have tested at very high concentrations of PCBs, and both Massachusetts and Connecticut have issued consumption advisories. 
              Humans are also at risk for exposure by direct contact with contaminated soil or sediment, or consumption of agricultural products produced in the floodplain. 
              PCBs could remain present in the Housatonic River ecosystem for hundreds of years without intervention.
            </p>
            <p>Source: <a href='https://www.epa.gov/ge-housatonic' target = '_blank'>EPA</a></p>
            <img src='images/housatonic-warning.jpg'>
            <p>Photo Credit: <a href='https://www.manchesterjournal.com/stories/think-decades-not-years-to-achieve-one-housatonic-river-health-marker,602748?'>Eagle File Photo</a></p>
          </div>

          <!-- Scene 3 -->
          <div class="step">
            <h3>Southeast Missouri Lead District</h3>
            <p>Missouri is home to the largest lead concentrations in the world, which has been mined for over a century. 
              The seven Superfund sites seen here are defunct lead mines located in the Southeast Missouri Lead District. 
              Mining at these sites left behind hundreds of millions of tons of mining waste contaminated with lead, and other heavy metals and toxic chemicals. 
              Much of this waste is in the form of enormous chat piles that are susceptible to wind and water erosion. 
              By the time the EPA began remediating sites, covering these piles to prevent erosion, the damage was already done.
            </p>
            <p>Source: <a href='http://www.msnbc.com/msnbc/life-missouris-fading-old-lead-belt' target = '_blank'>Life in Missouri’s Fading Old Lead Belt</a></p>
            <img src='images/park-hills-chat-pile.jpg'>
            <p>Photo Credit: <a href='http://www.nbcnews.com/id/8132449/ns/us_news-environment/t/toxic-mound-beloved-ex-mining-town/#.XrttSmhKg2w'>James A. Finley / AP</a></p>
          </div>

          <!-- Scene 3a -->
          <div class="step">
            <p>Contaminants from the chat piles has been distributed throughout the area, now encompassing an area much larger than is first suggested by the location of each site. 
              The total area affected by these seven Superfund sites covers four entire counties in Missouri: Washington, Jefferson, St. Francois, and Madison.
            </p>
          </div>

          <!-- Scene 3b -->
          <div class="step">
            <p>Heavy metals and toxic chemicals also leached into groundwater, eventually draining into the Big River, which runs through Washington, Jefferson, and St. Francois counties. 
              In 1977, heavy rains caused an estimated 50,000 cubic yards of contaminated mining waste to slough into the Big River. 
              As part of remediation efforts, the EPA conducts soil testing and cleanup for properties along the river and located on its floodplain. 
              The EPA also recommends that children in the area undergo annual blood testing for lead.
            </p>
            <p>Source: <a href='epa.gov/mo/big-river-and-floodplain-st-francois-jefferson-and-washington-counties-missouri-fact-sheet-july' target = '_blank'>EPA</a></p>
            <img src='images/big-river-warning.jpg'>
            <p>Photo Credit: <a href='https://www.kbia.org/post/big-river-still-dealing-lead-mining-waste#stream/0'>Kristofor Husted / KBIA</a></p>
          </div>

          <!-- Scene 4 -->
          <div class="step">
            <h3>Toxics Release Inventory (TRI) Program</h3>
            <p>The EPA also monitors active facilities all over the country that are currently releasing toxic chemicals into our air, water, and land through the TRI. 
              The TRI was established under the Emergency Planning and Community Right-to-Know Act (EPCRA) of 1986 after public concern grew over the 1984 Bhopal, India disaster, in which an American-owned Union Carbide pesticide plant released a cloud of highly toxic methyl isocyanate into the air, killing thousands of people. 
              Then in 1985, another, although smaller, toxic cloud was released from a Union Carbide plant on the Kanawha River in West Virginia.
            </p>
            <p>As of 2018 there are 21,557 facilities that report the release of a toxic chemical as part of the TRI program. 
              The TRI tracks these releases to provide the public with information and hopefully incentivize companies to improve their environmental performance. 
            </p>
          </div>

         <!-- Scene 4a -->
          <div class="step">
            <div class="tri-time-slider-total">
              <h3>Top 100 Releasing Facilities (total lbs)</h3>
              <label id="total-year">1987</label>
              <input id="total-slider" type="range" min="1987" max="2018" step="1" value="0" />
              </div>
            <!-- <div id="timeline"> -->
              <svg id = 'year-chart' width="650" height="500"></svg>
              <p>I need to add a legend, and fix the circle radius.</p>
              <p>I want to create some sort of D3 bar chart that shows total lbs released each year, that highlights the right bar according to the time slider.</p>
            <!-- </div> -->
          </div>

          <!-- Scene 5 -->
          <div class="step">
            <p>In 2007 the EPA introduced the Risk-Screening Environmental Indicators (RSEI) model to help provide context to the information collected by the TRI. 
              RSEI scores consider not only the size of the chemical release, but also the chemical’s toxicity, its fate and transport through the environment, and the size and location of the exposed population. 
              These scores can be used to help identify facilities or chemicals that may pose greater human health risk. 
              For 2018 data, some of the highest scores were the result of ethylene oxide emissions..
            </p>
            <p>Need to add a legend.
            </p>
            <p>The EPA classified ethylene oxide as a carcinogen in 2016, stating that it is at least 30 times more carcinogenic than previously understood, and that long-term exposure can cause an increased risk of cancers of the white blood cells and breast cancer in females. 
            </p>
            <svg id = 'donut-chart' width="600" height="500"></svg>
            <!-- <div>
              <input type="radio" id="chromium" name="chemical" value="chromium-layer" checked="checked" onclick="updateMap(value)">
              <label for="chromium">chromium and chromium compounds</label>
          
              <input type="radio" id="ethylene" name="chemical" value="ethylene-layer" onclick="updateMap(value)">
              <label for="ethylene">ethylene oxide</label>
            </div> -->
            <!-- <nav id="menu"></nav> -->
          </div>

          <!-- Scene 5a -->
          <div class="step">
            <p>The largest emissions are occurring along the Gulf, in Texas and Louisiana.
            </p>
            <p>Texas is currently looking to increase their limits.   
            </p>
          </div>

          <!-- Scene 5b -->
          <div class="step">
            <p>Louisiana houses 13 of the 109 emitting ethylene oxide facilities in the US, but is responsible for approximately one-fifth of those total emissions. 
              This area has become known as “Cancer Alley” due to these facilities and others.
            </p>
          </div>

          <!-- Scene 5c -->
          <div class="step">
            <p>Residents and environmental activists in St. James parish are currently fighting against the construction of a new plastics facility. 
              The enormous 2,300 acre facility proposed by Formosa Petrochemical Corporation could double the amount of toxic emissions already being released into the parish’s air.
            </p>
          </div>

          <!-- Scene 6 -->
          <div class="step">
            <h3>Chemical Valley, West Virginia</h3>
            <p>Let’s go back to West Virginia, where a 1985 chemical release along the Kanawha River helped fuel public outcry for the establishment of the TRI program. 
              Chemical Valley, as the area around Charleston WV has been dubbed, has long been a site of mining and chemical production. 
              As of 2018, there are still several facilities in the area that report toxic releases to the TRI. 
            </p>
            <img src='images/wv-monsanto.jpg'>
          </div>

          <!-- Scene 6a -->
          <div class="step">
            <p>On a January morning in 2014, around 7,500 gallons of crude 4-Methylcyclohexanemethanol (MCHM) spilled into the Elk River, a tributary of the Kanawha River. 
              The spill originated from Freedom Industries, a chemical plant whose permits did not allow for the discharge of MCHM. 
              MCHM is used as a cleansing agent to remove impurities from coal that contribute to pollution during combustion.
            </p>
            <img src='images/elk-river.jpg'>
          </div>

          <!-- Scene 6b -->
          <div class="step">
            <p>The spill occurred upstream from the primary West Virginia American Water intake, treatment, and distribution center. 
              While it may not pose any proven long-term health effects, over 300,000 residents in nine counties were without drinking water for several days.
            </p>
          </div>

          <!-- Scene 6c -->
          <div class="step">
            <p>Of course the same rivers that provide us with drinking water also tend to be perfect locations for industry. 
              Show TRI facilities with one-mile of a river here.
            </p>
          </div>

          <!-- Scene 8 -->
          <div class="step">
            <h3>Who profits?</h3>
            <p>The companies that own and profit from these facilities are often located far from the damage they cause.
            </p>
            <p>Show dropdown where user can choose one of the top 10 parent companies, that also filters and shows child companies connected by line.
            </p>
            <div class="dropdown show">
              <a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="parent-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Choose a company
              </a>
              <div class="dropdown-menu" id="parent-dropdown" aria-labelledby="dropdownMenuLink">
              </div>
              </div>
              <div id ="company-name"><h3></h3></div>
              <div id ="company-details"><p></p></div>
            </div>
          </div>

          <!-- Scene 9 -->
          <div class="step">
            <h3>How does this affect you?</h3>
            <p>geocode option to find sites close to you?</p>
          </div>

        </article>
  
      </section>
  
      <!-- OPIONAL: Scrollytelling Outro --> 
      <section id="outro">
        <p style="text-align : center"><br><a href="#top">Jump to top of page</a><br></p>
      </section>
    
    </main>
  

    </section>
      
       

    <!-- Bootstrap core CSS -->
    <link href="vendor\bootstrap\css\bootstrap.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" /> -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css" rel="stylesheet" />
    <!-- Custom styles for this template -->
    <link href='css/style.css' rel='stylesheet' />
    <!-- <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.Default.css"> />
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.css"> /> -->
    <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Average&display=swap" rel="stylesheet">
<body>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="../../../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.js"></script>
    <!-- <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script> -->
    <!-- <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://unpkg.com/d3@5.9.1/dist/d3.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/scrollama/2.2.1/scrollama.min.js"></script>
    <!-- <script src="libs/Leaflet.markercluster/leaflet.markercluster.js"></script> -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.5/chroma.min.js"></script>
    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>





    <!-- <script src='js/app.js'></script> -->

    <script>

      // force page to reload at top
      // jQuery(document).ready(function(){
      //   jQuery(this).scrollTop(0);
      // });

  // ---------Section 0: Make a scrollama--------------- 
  // Create a scrollama object.
  // ---------------------------------------------------
  var myScrollama = scrollama();

  // ---------Section 1: Set Heights---------------
  //#region
  // Set the size of the figure and the height of the steps
  // These are set to constants to improve performance on mobile devices, while keeping the code relatively simple.
  // ----------------------------------------------
  const figureHeight = window.innerHeight * 0.8
  const figureMarginTop = (window.innerHeight - figureHeight) / 2
  const stepH = Math.floor(window.innerHeight * 1.8);
  //#endregion

  // ---------Section 2: HTML -> D3--------------- 
  //#region
  // Save different parts of the page as D3.js objects. We'll use these later for easy restyling. D3.js is used for convenience.
  // ---------------------------------------------
  var figure = d3.select('figure');
  var article = d3.select('article');
  var steps = d3.selectAll('.step');
  //#endregion

  // ---------Section 3: handleResize()---------------
  //#region
  // Create a function which sets the styling of the various elements exactly as you want it to appear
  // This function could increase in complexity as you build responsive scrollytelling webpages. Here, this function
  // is relatively simple.
  // -------------------------------------------------
  function handleResize() {
    
    console.log("handling resize")

    // 1. update height of step elements
    steps.style('height', stepH + 'px');

    // 2. update height, margin, and layering of the figure
    figure
      .style('height', figureHeight + 'px')
      .style('top', figureMarginTop + 'px')
      .style("z-index", 1);

    // 3. force the article to appear on top of the figure
    article.style("z-index", 2);

    // 4. tell scrollama to update new element dimensions. Not always necessary, but included just to be safe.
    myScrollama.resize();

  }
  //#endregion

  // ---------Section 4: handleStepChange()---------------
  // Create a function to update the map in response to step-triggers.
  // setting map view, and removing and adding layers
  // this gets a little complicated/clunky and I'm not sure this is the best way to proceed
  // -----------------------------------------------------
  function handleStepChange(response) {
  
    console.log(response)

    // create array of layers to be turned off in each case before adding back relevant layers
    const allLayers = ['superfund-layer', 'superfund-labels', 'tri-layer', 'ge-layer', 'watershed-layer', 'river-layer', 'lead-belt-area-layer', 'tri-release-layer', 'ethylene-layer', 'chromium-layer', 'st-james-layer', 'spill-layer', 'tri-river-layer', 'parent-co-layer']

    // create object containing all layer ids and a corresponding label to use in legend
    // const layerLabels = {
    //   'superfund-layer': {
    //     'label': 'Superfund Sites'
    //   },
    //   'superfund-labels': {
    //     'label': ''
    //   },
    //   'tri-layer': {
    //     'label': 'TRI Facilities'
    //   },
    //   'ge-layer': {
    //     'label': 'GE Pittsfield Cleanup Area'
    //   },
    //   'watershed-layer': {
    //     'label': 'watershed'
    //   },
    //   'river-layer': {
    //     'label': 'river'
    //   },
    //   'lead-belt-area-layer': {
    //     'label': 'county outlines'
    //   },
    //   'tri-release-layer': {
    //     'label': ''
    //   },
    //   'ethylene-layer': {
    //     'label': 'ethylene oxide releasing facilities'
    //   },
    //   'chromium-layer': {
    //     'label': 'chromium/chromium compound releasing facilities'
    //   },
    //   'st-james-layer': {
    //     'label': 'St. James Parish'
    //   },
    //   'spill-layer': {
    //     'label': 'county outlines'
    //   },
    //   'tri-river-layer': {
    //     'label': 'TRI facilities'
    //   },
    //   'parent-co-layer': {
    //     'label': 'parent companies'
    //   }
    // }

    // convert keys from layer object into an array to be easily looped through during each scene change
    // const allLayers = Object.keys(layerLabels)

    // create array of individual markers to be removed in each case before adding back relevant markers
    const allMarkers = [freedomMarker]
    
    function updateLegend(allLayers) {

      // first clear legend
      document.getElementById('legend').innerHTML = "";

      // then select the legend div element
      var legend = document.getElementById('legend')

      // loop through each layer
      allLayers.forEach(function(layer) {
        
        layout = map.getLayoutProperty(layer, 'visibility')

        if (layer === 'tri-release-layer' && layout === 'visible') {
          drawCircleLegend(layer)
        } else if (layer === 'ethylene-layer' && layout === 'visible') {
          drawCircleLegend(layer)
        } else {
          layerType = map.getLayer(layer).type

          // if layer is visible in the scene
          if (layout === 'visible') {

            // first define color for legend key based on layer type (circle, line, or fill)
            if (layerType === 'circle') {
              var color = map.getPaintProperty(layer, 'circle-color')
            } else if (layerType === 'line') {
              var color = map.getPaintProperty(layer, 'line-color')
            } else if (layerType === 'fill') {
              var color = map.getPaintProperty(layer, 'fill-color')
            }

            // and append the layer's color and label to the legend element
            legend.innerHTML +=
            '<span style="background-color:' + color + '"></span> ' +
            '<label>' + layer + '</label><br>';
          }
        }
        })
      } 

      function drawCircleLegend(layer) {
        mapLayer = map.getLayer(layer)
      }

    switch(response.index) {
      case 0:
        // Scene 1
        // Superfund sites
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', null);
        map.setPaintProperty('superfund-layer', 'circle-radius', 2.5)
        updateLegend(allLayers);


        // humanExposureLegend.style.display = 'none';
        break;

      case 1:
        // Scene 2
        // GE Pittsfield Site
        map.flyTo({
          center: [-73.2420, 42.4483],
          zoom: 14,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['==', 'SITE_NAME', 'GE PITTSFIELD HOUSATONIC RIVER SUPERFUND SITE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6);
        updateLegend(allLayers);

        break;
      
      case 2:
        // Scene 2a
        // Full GE site extent map
        map.flyTo({
          center: [-73.2519, 42.4488], 
          zoom: 13,
          pitch: 0,
          bearing: 0,
          speed: .25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['==', 'SITE_NAME', 'GE PITTSFIELD HOUSATONIC RIVER SUPERFUND SITE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6)
        map.setLayoutProperty('ge-layer','visibility', 'visible');
        updateLegend(allLayers);

        break;

      case 3:
        // Scene 2b
        // Housatonic River extent
        map.flyTo({
          center: [-72.87774, 42.18110], 
          zoom: 8.92,
          pitch: 37.8,
          bearing: 129.64,
          speed: .3
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('river-layer','visibility', 'visible');
        map.setFilter('river-layer', ['in', 'name', 'Housatonic River', 'East Branch Housatonic River']);
        map.setLayoutProperty('watershed-layer','visibility', 'visible');
        map.setFilter('watershed-layer', ['==', 'NAME', 'Housatonic']);
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['==', 'SITE_NAME', 'GE PITTSFIELD HOUSATONIC RIVER SUPERFUND SITE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6);
        updateLegend(allLayers);

        break;

      case 4:
        // Scene 3
        // Missouri Old Lead Belt sites
        map.flyTo({
          center: [-90.8029, 37.852], 
          zoom: 9,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setLayoutProperty('superfund-labels','visibility', 'visible');
        map.setFilter('superfund-labels', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6);
        updateLegend(allLayers);

        break;

      case 5:
        // Scene 3a
        // Missouri Old Lead Belt areas
        map.flyTo({
          center: [-90.97511, 37.98508], 
          zoom: 8,
          pitch: 0,
          bearing: 0,
          speed: .25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setFilter('superfund-layer', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setLayoutProperty('superfund-labels','visibility', 'visible');
        map.setFilter('superfund-labels', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6)
        map.setLayoutProperty('lead-belt-area-layer','visibility', 'visible');
        updateLegend(allLayers);

        break;

      case 6:
      // Scene 3b
      // Big River
        map.flyTo({
          center: [-90.78435, 38.03558], 
          zoom: 9.87,
          pitch: 38.5,
          bearing: -21.6,
          speed: .5
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('superfund-layer','visibility', 'visible');
        map.setLayoutProperty('watershed-layer','visibility', 'visible');
        map.setFilter('watershed-layer', ['==', 'NAME', 'Big']);
        map.setLayoutProperty('river-layer','visibility', 'visible');
        map.setFilter('river-layer', ['==', 'name', 'Big River']);
        map.setFilter('superfund-layer', ['in', 'SITE_NAME', 'BIG RIVER MINE TAILINGS/ST. JOE MINERALS CORP.', 'WASHINGTON COUNTY LEAD DISTRICT - FURNACE CREEK', 'WASHINGTON COUNTY LEAD DISTRICT - POTOSI', 'WASHINGTON COUNTY LEAD DISTRICT - OLD MINES', 'WASHINGTON COUNTY LEAD DISTRICT - RICHWOODS', 'SOUTHWEST JEFFERSON COUNTY MINING', 'ANSCHUTZ - MADISON MINE']);
        map.setPaintProperty('superfund-layer', 'circle-radius', 6);
        updateLegend(allLayers);

        break;

      case 7:
        // Scene 4
        // overall TRI facility distribution
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-layer','visibility', 'visible');
        map.setFilter('tri-layer', null);
        map.setPaintProperty('tri-layer', 'circle-radius', 2);
        updateLegend(allLayers);

        break;

      case 8:
        // Scene 4a
        // TRI top releasing facilities--time slider
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-release-layer','visibility', 'visible');
        filterTotalRelease('1987');
        updateLegend(allLayers);

        break;

      case 9:
        // Scene 5
        // RSEI scores--chromium and ethylene oxide
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        // map.setLayoutProperty('chromium-layer','visibility', 'visible');
        updateLegend(allLayers);

        break;

        case 10:
        // Scene 5a
        // ethylene oxide emissions
        map.flyTo({
          center: [-97.7543, 28.7720],
          zoom: 4.789,
          pitch: 0,
          bearing: 0,
          speed: 0.5
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        updateLegend(allLayers);

        break;

        case 11:
        // Scene 5b
        // ethylene oxide louisiana
        map.flyTo({
          center: [-91.5343, 30.1251],
          zoom: 7.78,
          pitch: 0,
          bearing: 0,
          speed: 0.5
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        updateLegend(allLayers);

        break;

        case 12:
        // Scene 5c
        // new proposed plant
        map.flyTo({
          center: [-91.1824, 30.1043],
          zoom: 8.78,
          pitch: 0,
          bearing: 0,
          speed: 0.5
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('ethylene-layer','visibility', 'visible');
        map.setLayoutProperty('st-james-layer','visibility', 'visible');
        updateLegend(allLayers);

        break;

        case 13:
        // Scene 6
        // Chemical Valley, West Virginia
        map.flyTo({
          center: [-81.8162, 38.3771],
          zoom: 11.115,
          pitch: 59.5,
          bearing: 0,
          speed: 0.75
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-layer','visibility', 'visible');
        map.setPaintProperty('tri-layer', 'circle-radius', 6);
        updateLegend(allLayers);

        break;
        
        case 14:
        // Scene 6a
        // Zoom to Freedom Industry facility that had chemical spill
        map.flyTo({
          center: [-81.6713, 38.3618],
          zoom: 10.78,
          pitch: 0,
          bearing: 0,
          speed: 0.25
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('tri-layer','visibility', 'visible');
        map.setPaintProperty('tri-layer', 'circle-radius', 6);
        map.once('moveend', function(e) {
          freedomMarker.addTo(map);
        });
        updateLegend(allLayers);

        break;

        case 15:
        // Scene 6b
        // show counties affected by spill
        map.flyTo({
          center: [-81.6153, 38.3681],
          zoom: 8,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('spill-layer','visibility', 'visible');
        freedomMarker.addTo(map);
        updateLegend(allLayers);

        break;

        case 16:
        // Scene 7
        // all facilities along waterways in US?
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        if (map.getSource('company-line-source')) {
          map.removeLayer('company-line-layer')
          map.removeSource('company-line-source')
        };
        map.setLayoutProperty('tri-river-layer','visibility', 'visible');
        updateLegend(allLayers);

        break;

        case 17:
        // Scene 8
        // Parent Companies
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        map.setLayoutProperty('parent-co-layer','visibility', 'visible');
        map.setPaintProperty('tri-layer', 'circle-radius', 4)
        updateLegend(allLayers);
   
        break;

        case 18:
        // Scene 9
        // How does this affect you?
        // Geocode option to find sites close to you?
        map.flyTo({
          center: [-107.79, 35.08],
          zoom: 3.789,
          pitch: 0,
          bearing: 0
        });
        allLayers.forEach(item => map.setLayoutProperty(item, 'visibility', 'none'));
        allMarkers.forEach(item => item.remove());
        if (map.getSource('company-line-source')) {
          map.removeLayer('company-line-layer')
          map.removeSource('company-line-source')
        };
   
      default:
        // do nothing

    }

  }

  // ---------Section 5: init()--------------- 
  // Create a function that will run just once that first makes sure all the elements are sized like you want them,
  // and then sets up the scrollama. Finally, add an event listener to detect if the screen size has changed.
  // -----------------------------------------
  function init() {

    // 1. force a resize on load to ensure proper dimensions are sent to scrollama
    handleResize();

    // 2. Setup the scrollama
    myScrollama.setup({
      step: '.step',
      offset: Math.floor(window.innerHeight) * 0.95 + "px",
      // set to true to see debug horizontal line
      debug: true,
    }).onStepEnter(handleStepChange)
      
    // setup resize event
    window.addEventListener('resize', handleResize);
  }


  // ---------Section 6: Wrap Up--------------- 
  // This is where you'll want to include any other JavaScript that you've created for the webpage, and to run the init() function. 
  // ------------------------------------------
  // init();

  // DARK BASEMAP
  // add mapbox access token
  mapboxgl.accessToken = 'pk.eyJ1IjoiZWlsZWVuZ3JhZHkiLCJhIjoiY2pvNG00eXVjMDFlcjNxcW1yZ3I2OTJ2ZSJ9.l2EtBykdOJSCNiszd2NbaA';

  // initalize map
  var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/eileengrady/ck9vlhb4417hl1iqmcr1eoyr4', // stylesheet location
    center: [-107.79, 35.08], // starting position [lng, lat]
    zoom: 3.789, // starting zoom
    scrollZoom: false
  });

  map.addControl(new mapboxgl.NavigationControl());

  // create marker for Freedom Industries in WV
  var freedomMarker = new mapboxgl.Marker()
    .setLngLat([-81.606774, 38.368888])

    var years = [
      '1987',
      '1988',
      '1989',
      '1990',
      '1991',
      '1992',
      '1993',
      '1994',
      '1995',
      '1996',
      '1997',
      '1998',
      '1999',
      '2000',
      '2001',
      '2002',
      '2003',
      '2004',
      '2005',
      '2006',
      '2007',
      '2008',
      '2009',
      '2010',
      '2011',
      '2012',
      '2013',
      '2014',
      '2015',
      '2016',
      '2017',
      '2018'
    ];

    function filterTotalRelease(totalYear) {
      var total = 'TOTAL'
      var totalField = total.concat(totalYear)
      map.setPaintProperty('tri-release-layer', 'circle-radius', ['sqrt', ['/', ['get', totalField], 100000]]);
      map.setPaintProperty('tri-release-layer', 'circle-color', '#f94144');

      // Set the label to the month
      document.getElementById('total-year').textContent = totalYear;

      d3.selectAll('.bar')
        .filter(function(d) { return d.YEAR == totalYear; })
        .transition()
        .duration(300)
        .attr('opacity', 0.6)

      d3.selectAll('.bar')
        .filter(function(d) { return d.YEAR != totalYear; })
          .transition()
          .duration(300)
          .attr('opacity', 1)

        // .attr('x', (a) => xScale(a.TOTAL_RELEASE) - 5)
        // .attr('width', xScale.bandwidth() + 10)
    }

  const parentCompanies = ['US DEPARTMENT OF DEFENSE', 'BERKSHIRE HATHAWAY INC', 'CEMEX INC', 'ARGOS USA CORP', 'KOCH INDUSTRIES INC', 'CRH AMERICAS INC', 'CLEAN HARBORS INC', 'TYSON FOODS INC', 'MARATHON PETROLEUM CORP', 'MARTIN MARIETTA MATERIALS INC']
  
  function addCompanyFilter(company) {

    // make the selection once
    var dropdown = $('#parent-dropdown');

    //for each value in parent company array
    $.each(parentCompanies, function(key, value) {
      // append a new element
      dropdown.append("<a class='dropdown-item' value='"+ key +"' href='javascript:return false;''>" + value + "</a>")  //append new dropdown item
    });

    //assign click event to dropdown filter, call filterMap when dropdown selection made
    $('.dropdown-menu a').click(function(e) {
      company = this.innerHTML;
      filterMap(company);
      updateDetails(company)
    });
    }

    var popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false
    });

    function filterMap(company) {

      if (map.getSource('company-line-source')) {
        map.removeLayer('company-line-layer')
        map.removeSource('company-line-source')
      };
      
      map.setFilter('parent-co-layer', ['==', 'parentCompany', company]);
      map.setPaintProperty('parent-co-layer', 'circle-radius', 8);
      map.setLayoutProperty('tri-layer','visibility', 'visible'); 
      map.setFilter('tri-layer', ['==', 'PARENT_CO_NAME', company]);

      var facilities = map.querySourceFeatures('composite', {
          sourceLayer: 'tri-facilities-174q3j',
          filter: ['==', 'PARENT_CO_NAME', company]
      });

      var parent = map.querySourceFeatures('parent-co-source', {
          filter: ['==', 'parentCompany', company]
        });
      
      var from = turf.point([parent[0].properties.longitude, parent[0].properties.latitude]).geometry.coordinates;

      var lineData = []

      facilities.forEach(function(feature) {
        var to = turf.point([feature.properties.LONGITUDE, feature.properties.LATITUDE]).geometry.coordinates;
        var line = turf.lineString([from, to]);
        lineData.push(line)
      })


      map.addSource('company-line-source', {
         type: 'geojson', 
         data: {
           'type': 'FeatureCollection',
           'features': lineData
         }
      });
      
      map.addLayer({
        'id': 'company-line-layer',
        'type': 'line',
        'source': 'company-line-source',
        'layout': {
          'line-join': 'round',
          'line-cap': 'round'
        },
        'paint': {
          'line-color': '#888',
          'line-width': 1,
          'line-opacity': .5
        }
      });


      
      // map.on('mouseenter', 'tri-layer', function(e) {
    
      //   // var features = map.queryRenderedFeatures(e.point);
      //   var feature = e.features[0];
      //   // console.log(features)

      //   map.getCanvas().style.cursor = 'pointer';

      //   var parent = map.querySourceFeatures('parent-co-source', {
      //     // sourceLayer: 'parent-source-layer',
      //     filter: ['==', 'parentCompany', feature.properties.PARENT_CO_NAME]
      //   });

      //   // var parentCo = parent[0].properties.parentCompany

      //   var from = turf.point(e.features[0].geometry.coordinates);
      //   var to = turf.point([parent[0].properties.longitude, parent[0].properties.latitude]);

      //   var options = {units: 'miles'};

      //   var distance = turf.distance(from, to, options);

      //   // Populate the popup and set its coordinates
      //   // based on the feature found.
      //   popup.setLngLat(e.features[0].geometry.coordinates)
      //       .setHTML('<h3>' + 
      //         e.features[0].properties.FACILITY_NAME + 
      //         ' is ' + 
      //         distance + 
      //         ' miles from its parent company, ' + 
      //         parent[0].properties.parentCompany + 
      //         '.<h/3>')
      //       .addTo(map);

      // });

      // map.on('mouseleave', 'tri-layer', function() {
      //   map.getCanvas().style.cursor = '';
      //   popup.remove();
      // });
    }

    // need to access parent company layer data to update info box with description of each company
    function updateDetails(company) {
      var parentCompany = map.querySourceFeatures('parent-co-source', {
          filter: ['==', 'parentCompany', company]
        });
      console.log(parentCompany[0].properties.parentCompany)
      $('#company-name').text(parentCompany[0].properties.name)
      $('#company-details').text(parentCompany[0].properties.industry)
    }


    addCompanyFilter()

  map.on('load', function() {

    var popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false
    });

    // construct popup for Superfund sites
    map.on('mouseenter', 'superfund-layer', function(e) {
      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = 'pointer';

      var coordinates = e.features[0].geometry.coordinates.slice();

      // Ensure that if the map is zoomed out such that multiple
      // copies of the feature are visible, the popup appears
      // over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      // Populate the popup and set its coordinates
      // based on the feature found.
      popup
      .setLngLat(coordinates)
      .setHTML('<h3>' + e.features[0].properties.SITE_NAME + '<h/3>' +
        '<h4>Location: ' + e.features[0].properties.CITY + ' ' + e.features[0].properties.STATE + '<h/4>' +
        '<h4>Site Type: ' + e.features[0].properties.SITE_TYPE + '<h/4>' +
        '<h4>Status: ' + e.features[0].properties.NPL_STATUS_x + '<h/4>' +
        '<h4>HRS score: ' + e.features[0].properties.HRS_SCORE + '<h/4>')
      .addTo(map);
    });

    map.on('mouseleave', 'superfund-layer', function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
    });

    // add source and layer for GE Pittsfield site map
    map.addSource('ge-source', {
      type: 'geojson',
      data: 'data/ge-site-area.geojson'
    });

    map.addLayer({
      'id': 'ge-layer',
      'type': 'line',
      'source': 'ge-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#F9C74F',
        'line-width': 1
      }
    });

    // construct popup for GE site map layer
    map.on('mouseenter', 'ge-layer', function(e) {
      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = 'pointer';

      // var coordinates = e.features[0].geometry.coordinates[0];
      var coordinates = e.lngLat;

      // Ensure that if the map is zoomed out such that multiple
      // copies of the feature are visible, the popup appears
      // over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }

    // Populate the popup and set its coordinates
    // based on the feature found.
    popup
      .setLngLat(coordinates)
      .setHTML('<h3>' + e.features[0].properties.name + '<h/3>')
      .addTo(map);
    });

    map.on('mouseleave', 'ge-layer', function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
    });

    // add source and layer for watershed layer
    map.addSource('watershed-source', {
      type: 'geojson',
      data: 'data/watersheds/watersheds.geojson'
    });

    map.addLayer({
      'id': 'watershed-layer',
      'type': 'fill',
      'source': 'watershed-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'fill-color': '#A2D9CE',
        'fill-opacity': .25,
        'fill-outline-color': '#A2D9CE'
      }
    });

    // add source and layer for River layer
    map.addSource('river-source', {
      type: 'geojson',
      data: 'data/rivers.geojson'
    });

    map.addLayer({
      'id': 'river-layer',
      'type': 'line',
      'source': 'river-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#5FAECC',
        'line-width': 3
      }
    });

    // add source and layer for Lead Belt areas
    map.addSource('lead-belt-area-source', {
      type: 'geojson',
      data: 'data/missouri-lead-belt.geojson'
    });

    map.addLayer({
      'id': 'lead-belt-area-layer',
      'type': 'line',
      'source': 'lead-belt-area-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#43AA8B',
        'line-width': 2
      }
    });

    // add source and layer for top tri sites
    map.addSource('tri-release-source', {
      type: 'geojson',
      data: 'data/top-tri-releases.geojson'
    });

    map.addLayer({
      'id': 'tri-release-layer',
      'type': 'circle',
      'source': 'tri-release-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#f94144',
        'circle-radius': [
          'sqrt', ['/', ['get', 'TOTAL1987'], 100000]
        ],
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5
      }
    });

    filterTotalRelease('1987');

    document
      .getElementById('total-slider')
      .addEventListener('input', function(e) {
      var year = parseInt(e.target.value, 10);
      filterTotalRelease(year);
      console.log(year)
    });

    // add sources and layers for chromium and ethylene oxide facilities
    map.addSource('chromium-source', {
      type: 'geojson',
      data: 'data/chromium-facilities.geojson'
    });

    map.addSource('ethylene-source', {
      type: 'geojson',
      data: 'data/ethylene-facilities.geojson'
    });

    map.addLayer({
      'id': 'chromium-layer',
      'type': 'circle',
      'source': 'chromium-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#FF9933',
        'circle-radius': [
          'sqrt', ['/', ['get', 'ON_SITE_RELEASE_TOTAL'], 1000]
        ],
        'circle-opacity': .75,
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5
      }
    });

    map.addLayer({
      'id': 'ethylene-layer',
      'type': 'circle',
      'source': 'ethylene-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#AAF0D1',
        'circle-radius': [
          'sqrt', ['/', ['get', 'ON_SITE_RELEASE_TOTAL'], 100]
        ],
        'circle-opacity': .75,
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5
      }
    });

    // add source and layer for St. James Parish
    map.addSource('st-james-source', {
      type: 'geojson',
      data: 'data/st-james-parish.geojson'
    });

    map.addLayer({
      'id': 'st-james-layer',
      'type': 'line',
      'source': 'st-james-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#43AA8B',
        'line-width': 2
      }
    });

    // add source and layer for counties affected by Freedom Industry spill
    map.addSource('spill-source', {
      type: 'geojson',
      data: 'data/elk-river-spill-counties.geojson'
    });

    map.addLayer({
      'id': 'spill-layer',
      'type': 'line',
      'source': 'spill-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'line-color': '#FF9933',
        'line-width': 2
      }
    });

    // add source and layer for tri facilities near rivers
    map.addSource('tri-river-source', {
      type: 'geojson',
      data: 'data/tri-near-rivers.geojson'
    });

    map.addLayer({
      'id': 'tri-river-layer',
      'type': 'circle',
      'source': 'tri-river-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#f94144',
        'circle-radius': 3,
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5
      }
    });

    // add source and layer for parent companies
    map.addSource('parent-co-source', {
      type: 'geojson',
      data: 'data/parent-companies.geojson'
    });

    map.addLayer({
      'id': 'parent-co-layer',
      'type': 'circle',
      'source': 'parent-co-source',
      'layout': {
        'visibility': 'none'
      },
      'paint': {
        'circle-color': '#5DADEC',
        'circle-radius': 6,
        'circle-stroke-color':'#2f2d2d',
        'circle-stroke-width': 0.5
      }
    });

    // construct popup for GE site map layer
    map.on('mouseenter', 'parent-co-layer', function(e) {
      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = 'pointer';

      // var coordinates = e.features[0].geometry.coordinates[0];
      var coordinates = e.lngLat;

      // Ensure that if the map is zoomed out such that multiple
      // copies of the feature are visible, the popup appears
      // over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      // Populate the popup and set its coordinates
      // based on the feature found.
      popup
        .setLngLat(coordinates)
        .setHTML('<h3>' + e.features[0].properties.parentCompany + '<h/3>')
        .addTo(map);
      });

      map.on('mouseleave', 'parent-co-layer', function() {
        map.getCanvas().style.cursor = '';
        popup.remove();
      });

        // function updateLegend() {
        //   layers.forEach(function(layerId) {
        //     console.log(layerId)

        //     // var layer = map.getLayer(layerid);
        //     // if (layer.type === 'circle') {
        //     //   layer.paint['circle-fill']
        //     // } else if (layer.type === 'fill') {
        //     //   layer.paint['line-color']
        //     // }

        //   // console.log(layers)
        //   })
        // } 


    init();
    drawYearChart();
    drawDonutChart();

  })

  function drawYearChart() {
    var svg = d3.select("#year-chart"),
        margin = 130,
        width = svg.attr("width") - margin,
        height = svg.attr("height") - margin;

    var xScale = d3.scaleBand().range ([0, width]).padding(0.4),
        yScale = d3.scaleLinear().range ([height, 0]);

    var g = svg.append("g")
               .attr("transform", "translate(" + 100 + "," + 100 + ")");

    d3.csv("/data/year-totals.csv").then(function(data) {

        xScale.domain(data.map(function(d) { return d.YEAR; }));
        yScale.domain([0, d3.max(data, function(d) { return d.TOTAL_RELEASE; })]);

        g.append("g")
         .attr("transform", "translate(0," + height + ")")
         .call(d3.axisBottom(xScale))
        .selectAll("text")
          .attr("transform", "rotate(45)")
          .attr("dy", ".35em")
          .style("text-anchor", "start");

        var formatValue = d3.format("0.2s");

        g.append("g")
         .call(d3.axisLeft(yScale).tickFormat(function(d){
             return formatValue(d);
         }).ticks(20, "~s"))
         .append("text")
         .attr("y", 6)
         .attr("dy", "0.71em")
         .attr("text-anchor", "end")
         .text("value");

         g.append('g')
        .attr('class', 'grid')
        .call(d3.axisLeft()
        .scale(yScale)
        .tickSize(-width, 0, 0)
        .tickFormat(''))

        svg.append('text')
        .attr('class', 'label')
        .attr('x', -(height / 2) - margin)
        .attr('y', margin / 2.2)
        .attr('transform', 'rotate(-90)')
        .attr('text-anchor', 'middle')
        .text('Total Pounds Released')

         g.selectAll(".bar")
         .data(data)
         .enter().append("rect")
         .attr("class", "bar")
         .attr("x", function(d) { return xScale(d.YEAR); })
         .attr("y", function(d) { return yScale(d.TOTAL_RELEASE); })
         .attr("width", xScale.bandwidth())
         .attr("height", function(d) { return height - yScale(d.TOTAL_RELEASE); })
        });

    }

    function drawDonutChart() {
    // var svg = d3.select("#donut-chart"),
    //     margin = 130,
    //     width = svg.attr("width") - margin,
    //     height = svg.attr("height") - margin;

    // // var xScale = d3.scaleBand().range ([0, width]).padding(0.4),
    // //     yScale = d3.scaleLinear().range ([height, 0]);

    // var g = svg.append("g")
    //            .attr("transform", "translate(" + 100 + "," + 100 + ")");

    // d3.csv("/data/chemical-scores.csv").then(function(data) {

    //     // xScale.domain(data.map(function(d) { return d.SortName; }));
    //     // yScale.domain([0, d3.max(data, function(d) { return d.Score; })]);

    //     var arc = d3.svg.arc()
    //       .outerRadius(r);

    //     var pie = d3.layout.pie()
    //       .value(function(d) { return d.Score; });

    //     var arcs = vis.selectAll("g.slice")
    //       .data(pie)
    //       .enter()
    //         .append("svg:g")
    //           .attr("class", "slice");

        // g.append("g")
        //  .attr("transform", "translate(0," + height + ")")
        //  .call(d3.axisBottom(xScale))
        // .selectAll("text")
        //   .attr("transform", "rotate(45)")
        //   .attr("dy", ".35em")
        //   .style("text-anchor", "start");

        // var formatValue = d3.format("0.2s");

        // g.append("g")
        //  .call(d3.axisLeft(yScale).tickFormat(function(d){
        //      return formatValue(d);
        //  }).ticks(20, "~s"))
        //  .append("text")
        //  .attr("y", 6)
        //  .attr("dy", "0.71em")
        //  .attr("text-anchor", "end")
        //  .text("value");

        //  g.append('g')
        // .attr('class', 'grid')
        // .call(d3.axisLeft()
        // .scale(yScale)
        // .tickSize(-width, 0, 0)
        // .tickFormat(''))

        // svg.append('text')
        // .attr('class', 'label')
        // .attr('x', -(height / 2) - margin)
        // .attr('y', margin / 2.2)
        // .attr('transform', 'rotate(-90)')
        // .attr('text-anchor', 'middle')
        // .text('Total Pounds Released')

        //  g.selectAll(".bar")
        //  .data(data)
        //  .enter().append("rect")
        //  .attr("class", "bar")
        //  .attr("x", function(d) { return xScale(d.YSortName); })
        //  .attr("y", function(d) { return yScale(d.Score); })
        //  .attr("width", xScale.bandwidth())
        //  .attr("height", function(d) { return height - yScale(d.Score); })
        // });

    // })
  }
  

    </script>

    
  </body>

  
</html>
